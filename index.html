<html>
<head>
    <title>Twitch | Teams Page</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />
    <style>
        #different_team {
            float: right;
            width: 25%;
        }
        #different_team input {
            width: 100%;
        }

        
        #status {
            background: #000000;
            color: #FFFFFF;
            display: block;
            padding: 5px;
            margin: 2px;
            box-sizing: border-box;
        }

        
    </style>
    <script src="https://embed.twitch.tv/embed/v1.js"></script>

    <script type="text/javascript">
        if (document.location.hash && document.location.hash != '') {
            var parsedHash = new URLSearchParams(window.location.hash.substr(1));
            if (parsedHash.get('access_token')) {
                if (window.opener) {
                    window.opener.processToken(parsedHash.get('access_token'));
                    window.close();
                }
            }
        }

        if (document.location.search && document.location.search != '') {
            var parsedParams = new URLSearchParams(window.location.search);
            if (parsedParams.get('error_description')) {
                document.getElementById('status').classList.add('show');
                document.getElementById('status').textContent = 'Looks like you Tried to oAuth Authenticate and Somethibg went wrong: ' + parsedParams.get('error') + ' - ' + parsedParams.get('error_description');
            }
        }
    </script>
</head>
<body>

    <p id="redirect_value">target</p>

    <a href="" id="authorize" target="barrysgithubtwitchauth">Authorize</a>
    <div id="different_team">
        <form action="" method="post" id="different_team_form">
            <input type="text" name="different_team_field" id="different_team_field" placeholder="Different Team (Hit Enter)" disabled />
        </form>
    </div>

    <div id="status">Pending</div>

    <div id="response">
        response
    </div>

    <div id="response1">
        response
    </div>

    <ul class="collection">

    </ul>

    <script type="text/javascript">
        // go populate this with a client_id
        var client_id = 'jm9omolnvrbdhe7i9k774xys65k5ec';
        var redirect = 'https://dm16g12.github.io';
        // setup a memory space for the token/userID
        var access_token = '';
        var user_id = '';

        let status = document.getElementById('status');

        // setuo authorise link
        document.getElementById('authorize').setAttribute('href', 'https://id.twitch.tv/oauth2/authorize?client_id=' + client_id + '&redirect_uri=' + encodeURIComponent(redirect) + '&response_type=token&scope=user:read:follows')

        function processToken(token) {
            access_token = token;

            status.textContent = 'Got Token. Loading Things';

            myOwn(60600844);

            document.getElementById('redirect_value').textContent = `redirect value = ${redirect}`;

            document.getElementById('different_team_field').removeAttribute('disabled');
        }


        function myOwn(id) {
            let url = new URL('https://api.twitch.tv/helix/streams/followed?user_id=60600844');
            

            fetch(
                url,
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
            .then(resp => resp.json())
            .then(async resp => {
                // https://github.com/twitchdev/issues/issues/495
                if (resp.data.length > 0) {
                    let team = resp.data;
                    let user_list = []
                    user_list = resp.data;


                    let resp_length = resp.data.length;
                    document.getElementById('response').textContent = resp_length;
                    
                    console.log(resp.data);
                    console.log(resp.data[0]);
                    console.log(resp.data[0].user_name);
                    console.log(user_list);
                    const li = document.createElement('li');

                    user_list.forEach(user => {
                        console.log(user.user_name + " " + user.type + " " + user.title + " " + user.viewer_count);
                        li.appendChild(document.createTextNode(`${user.user_name}`));
                        document.querySelector('ul.collection').appendChild(li);

                    });

                    li.appendChild(document.createTextNode(`${user.user_name}`))

                    
                } else {
                    status.textContent = 'Team Not returned, is the name correct?';
                }
            })
            .catch(err => {
                console.error(err);
                status.textContent = 'An Error Occured loading Teams';
            });

            
        }

        
    </script>
</body>
</html>
